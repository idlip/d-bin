#!/usr/bin/env sh
MPC="mpc --quiet -p ${1:-6600}"
pidof -x mpd || mpd

source d-var.conf

DMENU() {
    # Vertical menu if $3 is given
    printf '%s\n' "$1" | $L_MENU -p "$2"
}

get_playlist() {
    $MPC -f "%position% - %artist% - %album% - %title%" playlist
}

select_from() {
    DMENU "$1" "Select $2" $height
}

add() {
    all="[ALL]"

    local artist=$(select_from "$($MPC list Artist)\n$all" "artist")

    if [ "$artist" = "$all" ]; then
        $MPC listall | $MPC add;
    elif [ -n "$artist" ]; then
        local albums=$($MPC list Album Artist "$artist")
        local album=$(select_from "$albums\n$all" "album")

        if [ "$album" = "$all" ]; then
            $MPC findadd Artist "$artist"
        elif [ -n "$album" ]; then
            local songs=$($MPC list Title Album "$album")
            local song=$(select_from "$songs\n$all" "song")

            if [ "$song" = "$all" ]; then
                $MPC findadd Album "$album"
            elif [ -n "$song" ]; then
                $MPC findadd Title "$song"
            fi
        fi
    fi
}

remove() {
    local playlist=$(get_playlist)
    local song=$(select_from "$playlist" "song")

    [ -n "$song" ] && $MPC del "${song%%\ *}"
}

queue() {
    nowp=$(mpc status | head -n1)
    nextp=$(mpc queued)
    notify-send "Now: $nowp" "Next: $nextp"
}

jump() {
    local playlist=$(get_playlist)
    local song=$(select_from "$playlist" "song")

    [ -n "$song" ] && $MPC play "${song%%\ *}"
}

toggle(){
    $MPC toggle
}

play(){
    $MPC findadd Title "$($MPC list title | $L_MENU)"
    $MPC play
}

pause(){
    $MPC pause
}

stop(){
    $MPC stop
}

next(){
    $MPC next
}

prev(){
    $MPC prev
}

ytmusic () {
    $MPC add "$(yt-dlp -f bestaudio -g "$(ytfzf -LD --ii='y.com.sb')")"
}

menuopts=( " Clear"  "󰐒 Add" "󰵩 Remove" "󱫜 Jump"  " Toggle" " Play"  " Pause"  " Stop" "󰒭 Next" "󰒮 Prev" "󱕱 Queued" " YT Music")

while true; do
    action=$(printf '%s\n' "${menuopts[@]}" | $L_MENU -p " Do you want to")
    case $action in
        "${menuopts[0]}") $MPC clear ;;
        "${menuopts[1]}") add ;;
        "${menuopts[2]}") remove ;;
        "${menuopts[3]}") jump ;;
        "${menuopts[4]}") toggle ;;
        "${menuopts[5]}") play ;;
        "${menuopts[6]}") pause ;;
        "${menuopts[7]}") stop ;;
        "${menuopts[8]}") next ;;
        "${menuopts[9]}") prev ;;
        "${menuopts[10]}") queue ;;
	    "${menuopts[11]}") ytmusic ;;
        "") exit 0;;
    esac
done
