#!/usr/bin/env bash

# Link handler for every thinkable purpose
# I use ts or tsp for task scheduling with mpv

source d-var.conf 

feed="${1:-$(printf "$(wl-paste -p)\n$(wl-paste)" | $D_MENU -i -p ' ')}"
echo "$feed" | wl-copy -n
# For prompt/notify on chosen link
shortfeed="$(echo ${feed} | cut -d '/' -f3,4,5,6 )"

# Aria2 for torrents (acts on rpc server)
aria_tor () {
    curl 'http://localhost:6800/jsonrpc' || setsid aria2c --enable-rpc --rpc-listen-all &
    sleep 4 && curl http://localhost:6800/jsonrpc -d '{"jsonrcp":"2.0","id":"someID","method":"aria2.addUri","params":["token:ariatest",["'${feed}'"]]}'
}

audio_podcast () {
    case "$(printf "Song\nPodcast" | $D_MENU -p ' ')" in
	"Podcast") NQDIR=/tmp/podcast nq mpv --geometry=15% --title=podcast --vid=1 "${feed}" >/dev/null 2>&1 ;;
	"Song") pgrep mpd || mpd; mpc add "$(yt-dlp -f bestaudio -g "${feed}")" && mpc play ;;
	*) exit 1 ;;
    esac
}

menuopts=("  Copy Url" "  Fire Fox" "  Download Files" "  YT Vid Download" "  Audio Music Download" "  Podcast Listen Stream" "  View Image" "  Play Watch Stream" "  Misc Download" "  Bookmark" "  Brave" "  Libre Wolf" "  Chromium" "  Torrent Aria" " YT Music")

case "$(printf '%s\n' "${menuopts[@]}" | sort | $D_MENU -p ${shortfeed})" in

    "${menuopts[0]}") echo "${feed}" | wl-copy -p ;;
    "${menuopts[1]}") setsid -f firefox "${feed}" >/dev/null 2>&1 ;;
    "${menuopts[2]}") setsid aria2c -j 6 -x 16 -c -d ~/dloads "${feed}" >/dev/null 2>&1 ;;
    "${menuopts[3]}") NQDIR=/tmp/yt-dlp nq yt-dlp --embed-metadata --embed-subs -f "bestvideo[height<=1080]+bestaudio" -P ~/vids/yt "${feed}" >/dev/null 2>&1 ;;
    "${menuopts[4]}") NQDIR=/tmp/yt-dlp nq yt-dlp -P ~/d-sync/music/yt/ -icx --embed-metadata "${feed}" && pidof -x mpd || mpd && mpc update ;;
    "${menuopts[5]}") audio_podcast ;;
    "${menuopts[6]}") curl "${feed}" --output /tmp/image  && imv /tmp/image || imv "${feed}" ;;
    "${menuopts[7]}") NQDIR=/tmp/stream nq mpv -quiet "${feed}" >/dev/null 2>&1 ;;
    "${menuopts[8]}") aria2c -j 6 -x 10 -c -d ~/vids/documentary/.cache/clean.db/ "${feed}" ;;
    "${menuopts[9]}") d-bookmark "${feed}" ;;
    "${menuopts[10]}") setsid brave "${feed}" ;;
    "${menuopts[11]}") setsid librewolf "${feed}" ;;
    "${menuopts[12]}") setsid chromium "${feed}" ;;
    "${menuopts[13]}") aria_tor ;;
    "${menuopts[14]}") pgrep mpd || mpd; mpc add "$(yt-dlp -f bestaudio -g "$(ytfzf -LD ${feed})")" && mpc play ;;
    *) exit 1 ;;
esac
