#!/usr/bin/env sh

source d-var.conf 

# Get link from user input or dmenu
feed="${1:-$(printf "%s" | $D_MENU -i -p 'Paste URL or file path')}"
echo "$feed" | wl-copy -n
shortfeed="$(echo ${feed} | cut -d '/' -f3,4,5,6 )"

aria_tor () {
    curl http://localhost:6800/jsonrpc -d '{"jsonrcp":"2.0","id":"someID","method":"aria2.addUri","params":["token:ariatest",["'${feed}'"]]}'
}

# Define programs to choose from
programs=(
    "echo '${feed}' | wl-copy -p"
    "setsid  rdrview -B w3m '${feed}'"
    "setsid -f firefox '${feed}' >/dev/null 2>&1"
    "setsid aria2c -j 6 -x 16 -c -d ~/dloads '${feed}' >/dev/null 2>&1"
    "TS_SOCKET=/tmp/yt-dlp ts yt-dlp --embed-metadata --embed-subs -f 'bestvideo[height<=1080]+bestaudio' -P ~/vids/yt '${feed}' >/dev/null 2>&1"
    "TS_SOCKET=/tmp/yt-dlp ts yt-dlp -P ~/music/yt/ -icx --embed-metadata '${feed}' && pidof -x mpd || mpd && mpc update"
    "ts mpv --geometry=15%-30-30 --vid=1 --external-file=/home/i/pics/dpics/nature/pod.jpg '${feed}' >/dev/null 2>&1"
    "curl '${feed}' --output /tmp/image  && imv /tmp/image || imv '${feed}'"
    "ts mpv -quiet '${feed}' >/dev/null 2>&1"
    "aria2c -j 6 -x 10 -c -d ~/vids/Documentary/.cache/clean.db/ '${feed}'"
    "d-bookmark '${feed}'"
    "setsid brave '${feed}'"
    "setsid librewolf '${feed}'"
    "setsid chromium '${feed}'"
    "aria_tor"
)


# Define program names for display
program_names=(
    "  Copy Url"
    "󱂿  Article Reader"
    "  Fire Fox"
    "  Download Files"
    "  YT Vid Download"
    "  Audio Music Listen"
    "  Podcast"
    "  View Image"
    "  Play Watch Stream"
    "  Misc Download"
    "  Bookmark"
    "  Brave"
    "  Libre Wolf"
    "  Chromium"
    "﨩  Torrent Aria"
)

# Get index of selected program
function get_program_index {
    local index=1
    for program in "${program_names[@]}"; do
        if [[ "$program" == "$1" ]]; then
            echo "$index"
            return
        fi
        ((index++))
    done
}

# Get user selection
# selected_program="$(printf '%s\n' "${program_names[@]}" | $D_MENU -i -mesg ${shortfeed})"
notify-send -t 2000 "Link: ${shortfeed}"
selected_program="$(printf '%s\n' "${program_names[@]}" | $D_MENU -i)"
if [[ -n "$selected_program" ]]; then
    selected_index="$(get_program_index "$selected_program")"
    echo "Evaluating:" "${programs[$selected_index-1]}"
    eval "${programs[$selected_index-1]}"
fi

